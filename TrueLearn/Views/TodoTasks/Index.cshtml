@{
	ViewBag.Title = "Task Calendar";
}

<h2>Task Calendar</h2>

<button id="btnCreate" class="btn btn-default btn-sm pull-right" style="margin-right:5px;">
	<span class="glyphicon glyphicon-pencil"></span> Create
</button>

<div id="calendar"></div>

<div id="myModal" class="modal fade" role="dialog">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal">&times;</button>
				<h4 class="modal-title"><span id="eventTitle"></span></h4>
			</div>
			<div class="modal-body">
				<button id="btnDelete" class="btn btn-default btn-sm pull-right">
					<span class="glyphicon glyphicon-remove"></span> Remove
				</button>
				<button id="btnEdit" class="btn btn-default btn-sm pull-right" style="margin-right:5px;">
					<span class="glyphicon glyphicon-pencil"></span> Edit
				</button>
				<p id="pDetails"></p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
			</div>
		</div>
	</div>
</div>

<div id="myModalCreate" class="modal fade" role="dialog">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal">&times;</button>
				<h4 class="modal-title"><span id="eventTitle"></span></h4>
			</div>
			<div class="modal-body">
				<input type="text" id="title" required />
				<input type="text" id="description" />
				<input type="date" id="start" required />
				<input type="date" id="end" required />

				<div class="form-group">
					<div class="col-md-offset-2 col-md-10">
						<button type="button" class="btn btn-default" id="create">Create Task</button>
					</div>
				</div>
			</div>
			}
		</div>
		<div class="modal-footer">
			<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
		</div>
	</div>
</div>
</div>


<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker.min.css" rel="stylesheet" />

@section scripts{



	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/js/bootstrap-datetimepicker.min.js"></script>
	<script src="~/Content/bootstrap-4.3.1-dist/js/bootstrap.min.js"></script>

	<script>
		$(document).ready(() => {
			let events = [];
			var selectedEvent = null;
			FetchEventAndRenderCalendar();
			function FetchEventAndRenderCalendar() {
				events = []
				$.ajax({
					method: "GET",
					url: "/TodoTasks/Events",
					success: function (response) {
						for (let x of response) {
							events.push({
								id: x.Id,
								title: x.title,
								description: x.description,
								start: x.start,
								end: x.end,
								allDay: true
							});
						}
						console.log(events);
						GenerateCalendar(events)
					},
					error: function (response) {
						alert('failed');
					}
				})
			}


			function GenerateCalendar(events) {
				$('#calendar').fullCalendar('destroy');
				$('#calendar').fullCalendar({
					contentHeight: 400,
					defaultDate: new Date(),
					timeFormat: 'h(:mm)a',
					header: {
						left: 'prev, next today',
						center: 'title',
					},
					eventColor: '#378006',
					events: events,
					eventClick: function (calEvent, jsEvent, view) {
						selectedEvent = calEvent;
						$('#myModal #eventTitle').text(calEvent.title);
						var $description = $('<div/>');
						$description.append($('<p/>').html('<b>Start:</b>' + calEvent.start.format("DD-MMM-YYYY HH:mm a")));
						if (calEvent.end != null) {
							$description.append($('<p/>').html('<b>End:</b>' + calEvent.end.format("DD-MMM-YYYY HH:mm a")));
						}
						$description.append($('<p/>').html('<b>Description:</b>' + calEvent.description));
						$('#myModal #pDetails').empty().html($description);

						$('#myModal').modal();
					},
				})
			}

			$('#btnCreate').click(function () {

				$('#myModalCreate').modal();
				$('#create').click(function () {
					$.ajax({
						method: "PUT",
						url: "/TodoTasks/Event",
						data: {
							UserId: $('#userId').val(),
							title: $('#title').val(),
							description: $('#description').val(),
							start_date: $('#start').val(),
							end_date: $('#end').val(),
						},
						success: function (response) {
							if (response) {
								FetchEventAndRenderCalendar();
								$('#myModalCreate').modal('hide');
							}
						},
						error: function () {
							alert('failed');
						}
					})
				})
			});

			$('#btnEdit').click(function () {

			});

			$('#btnDelete').click(function () {
				if (selectedEvent != null && confirm('Are you sure?')) {
					$.ajax({
						method: "DELETE",
						url: "/TodoTasks/Event",
						data: {
							id: selectedEvent.id
						},
						success: function (response) {
							if (response) {
								FetchEventAndRenderCalendar();
								$('#myModal').modal('hide');
							}
						},
						error: function () {
							alert('failed');
						}
					})
				}
			});
		});
	</script>
}
